#!/bin/bash

sudo tee /usr/local/bin/vpn-switch << â€˜EOFâ€™
#!/bin/bash

PROFILES_DIR=â€/etc/wireguard/profilesâ€
ACTIVE_CONFIG=â€/etc/wireguard/mulvad.confâ€

setup_killswitch() {
local config=â€$1â€
local endpoint=$(grep â€œEndpointâ€ â€œ$configâ€ | cut -dâ€™=â€™ -f2 | tr -d â€™ â€˜)
local server_ip=$(echo â€œ$endpointâ€ | cut -dâ€™:â€™ -f1)
local port=$(echo â€œ$endpointâ€ | cut -dâ€™:â€™ -f2)

```
sudo iptables -F && sudo iptables -X
sudo iptables -P INPUT ACCEPT && sudo iptables -P FORWARD ACCEPT && sudo iptables -P OUTPUT ACCEPT

# Allow loopback
sudo iptables -A INPUT -i lo -j ACCEPT
sudo iptables -A OUTPUT -o lo -j ACCEPT

# Allow VPN server connection
sudo iptables -A OUTPUT -d "$server_ip" -p udp --dport "$port" -j ACCEPT
sudo iptables -A INPUT -s "$server_ip" -p udp --sport "$port" -j ACCEPT

# Allow established connections
sudo iptables -A INPUT -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT
sudo iptables -A OUTPUT -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT

# Allow VPN interface traffic
sudo iptables -A OUTPUT -o mulvad -j ACCEPT
sudo iptables -A INPUT -i mulvad -j ACCEPT

# Drop everything else and set policies
sudo iptables -P INPUT DROP
sudo iptables -P FORWARD DROP  
sudo iptables -P OUTPUT DROP
```

}

restore_firewall() {
sudo iptables -F && sudo iptables -X
sudo iptables -P INPUT ACCEPT && sudo iptables -P FORWARD ACCEPT && sudo iptables -P OUTPUT ACCEPT
}

switch_profile() {
local profile=â€$1â€
local config_file=â€$PROFILES_DIR/$profile.confâ€

```
[ ! -f "$config_file" ] && { echo "âŒ Profile $profile not found"; exit 1; }

echo "ğŸ”¥ Switching to $profile..."

# Stop existing connection
sudo systemctl stop wg-quick@mulvad 2>/dev/null
sudo ip link delete mulvad 2>/dev/null

# Setup firewall before connecting
setup_killswitch "$config_file"

# Create symlink
sudo rm -f "$ACTIVE_CONFIG"
sudo ln -sf "$config_file" "$ACTIVE_CONFIG"

# Start VPN
if sudo systemctl start wg-quick@mulvad; then
    sleep 3
    if ip link show mulvad >/dev/null 2>&1; then
        echo "âœ… $profile ACTIVE"
        CURRENT_IP=$(timeout 10 curl -s --interface mulvad http://ipinfo.io/ip 2>/dev/null)
        [ -n "$CURRENT_IP" ] && echo "ğŸŒ IP: $CURRENT_IP" || echo "ğŸ”’ Protected (IP check failed)"
    else
        echo "âŒ Interface failed - LOCKDOWN ACTIVE"
    fi
else
    echo "âŒ VPN failed - LOCKDOWN ACTIVE"
fi

sudo iptables-save > /etc/iptables/iptables.rules 2>/dev/null
```

}

case â€œ$1â€ in
speed|privacy|streaming) switch_profile â€œ$1â€ ;;
off)
sudo systemctl stop wg-quick@mulvad
sudo ip link delete mulvad 2>/dev/null
restore_firewall
sudo iptables-save > /etc/iptables/iptables.rules 2>/dev/null
echo â€œâœ… VPN offâ€
;;
status)
if systemctl is-active â€“quiet wg-quick@mulvad && ip link show mulvad >/dev/null 2>&1; then
CURRENT_IP=$(timeout 5 curl -s http://ipinfo.io/ip 2>/dev/null)
echo â€œğŸŸ¢ ACTIVE: ${CURRENT_IP:-Unknown}â€
else
echo â€œğŸ”´ LOCKDOWNâ€
fi
;;
*)
echo â€œUsage: $0 [speed|privacy|streaming|off|status]â€
exit 1
;;
esac
EOF

sudo chmod +x /usr/local/bin/vpn-switch