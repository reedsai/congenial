#!/bin/bash

sudo tee /usr/local/bin/vpn-switch << â€˜EOFâ€™
#!/bin/bash

PROFILES_DIR=â€/etc/wireguard/profilesâ€
ACTIVE_CONFIG=â€/etc/wireguard/mulvad.confâ€

setup_killswitch() {
local config=â€$1â€
local endpoint=$(grep â€œEndpointâ€ â€œ$configâ€ | cut -dâ€™=â€™ -f2 | tr -d â€™ â€˜)
local server_ip=$(echo â€œ$endpointâ€ | cut -dâ€™:â€™ -f1)
local port=$(echo â€œ$endpointâ€ | cut -dâ€™:â€™ -f2)

```
sudo iptables -F && sudo iptables -X
sudo iptables -P INPUT DROP && sudo iptables -P FORWARD DROP && sudo iptables -P OUTPUT DROP

sudo iptables -A OUTPUT -d "$server_ip" -p udp --dport "$port" -j ACCEPT
sudo iptables -A OUTPUT -o mulvad -j ACCEPT
sudo iptables -A INPUT -i mulvad -j ACCEPT
sudo iptables -A INPUT -i lo -j ACCEPT
sudo iptables -A OUTPUT -o lo -j ACCEPT
sudo iptables -A OUTPUT -o mulvad -p udp --dport 53 -j ACCEPT
sudo iptables -A OUTPUT -o mulvad -p tcp --dport 53 -j ACCEPT
sudo iptables -A OUTPUT -o mulvad -p udp --dport 443 -j ACCEPT
sudo iptables -A OUTPUT -o mulvad -p tcp --dport 443 -j ACCEPT
sudo iptables -A INPUT -i mulvad -m conntrack --ctstate NEW,RELATED,ESTABLISHED -j ACCEPT
sudo iptables -A OUTPUT -o mulvad -m conntrack --ctstate NEW,RELATED,ESTABLISHED -j ACCEPT
sudo iptables -A INPUT -i mulvad -p tcp --dport 22 -j ACCEPT
```

}

restore_firewall() {
sudo iptables -F && sudo iptables -X
sudo iptables -P INPUT DROP && sudo iptables -P FORWARD DROP && sudo iptables -P OUTPUT DROP
sudo iptables -A INPUT -i lo -j ACCEPT && sudo iptables -A OUTPUT -o lo -j ACCEPT
sudo iptables -A INPUT -m conntrack â€“ctstate RELATED,ESTABLISHED -j ACCEPT
sudo iptables -A OUTPUT -m conntrack â€“ctstate RELATED,ESTABLISHED -j ACCEPT
sudo iptables -A INPUT -p tcp â€“dport 22 -m conntrack â€“ctstate NEW -j ACCEPT
sudo iptables -A OUTPUT -d 127.0.0.1 -p udp â€“dport 53 -j ACCEPT
sudo iptables -A OUTPUT -p tcp â€“dport 443 -j ACCEPT
sudo iptables -A OUTPUT -p tcp â€“dport 80 -j ACCEPT
sudo iptables -A OUTPUT -p udp â€“dport 123 -j ACCEPT
sudo iptables -A OUTPUT -p icmp â€“icmp-type 8 -j ACCEPT
}

switch_profile() {
local profile=â€$1â€
local config_file=â€$PROFILES_DIR/$profile.confâ€

```
[ ! -f "$config_file" ] && { echo "âŒ Profile $profile not found"; exit 1; }

echo "ğŸ”¥ $profile mode..."

sudo systemctl stop wg-quick@mulvad 2>/dev/null
setup_killswitch "$config_file"
sudo rm -f "$ACTIVE_CONFIG"
sudo ln -sf "$config_file" "$ACTIVE_CONFIG"

if sudo systemctl start wg-quick@mulvad; then
    sleep 3
    if ip link show mulvad >/dev/null 2>&1; then
        echo "âœ… $profile ACTIVE"
        CURRENT_IP=$(timeout 5 curl -s http://ipinfo.io/ip 2>/dev/null)
        [ -n "$CURRENT_IP" ] && echo "ğŸŒ IP: $CURRENT_IP" || echo "ğŸ”’ Protected"
    else
        echo "âŒ Interface failed - LOCKDOWN"
    fi
else
    echo "âŒ VPN failed - LOCKDOWN"
fi
sudo iptables-save | sudo tee /etc/iptables/iptables.rules > /dev/null
```

}

case â€œ$1â€ in
speed|privacy|streaming) switch_profile â€œ$1â€ ;;
off)
sudo systemctl stop wg-quick@mulvad
restore_firewall
sudo iptables-save | sudo tee /etc/iptables/iptables.rules > /dev/null
echo â€œâœ… VPN offâ€
;;
status)
if systemctl is-active â€“quiet wg-quick@mulvad && ip link show mulvad >/dev/null 2>&1; then
CURRENT_IP=$(timeout 3 curl -s http://ipinfo.io/ip 2>/dev/null)
echo â€œğŸŸ¢ ACTIVE: $CURRENT_IPâ€
else
echo â€œğŸ”´ LOCKDOWNâ€
fi
;;
*)
echo â€œUsage: $0 [speed|privacy|streaming|off|status]â€
exit 1
;;
esac
EOF

sudo chmod +x /usr/local/bin/vpn-switch