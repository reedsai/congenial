#!/bin/bash

# üî± ARCH FORTRESS - PART 2: ARSENAL DEPLOYMENT üî±

# Fixed Python compatibility and enhanced error handling

set -euo pipefail

# Colors for output

RED="\033[0;31m"
GREEN="\033[0;32m"
YELLOW="\033[1;33m"
BLUE="\033[0;34m"
NC="\033[0m"

# Configuration

USERNAME="mastermind"
HOSTNAME="fortress"
FIREFOX_PROFILE="fortress-secure"
DNS_NETWORK="dns-isolated"
FIREFOX_NETWORK="firefox-isolated"

# Logging functions

log() {
echo -e "${GREEN}[$(date +'%Y-%m-%d %H:%M:%S')]${NC} $1"
}

error() {
echo -e "${RED}[ERROR]${NC} $1" >&2
exit 1
}

warning() {
echo -e "${YELLOW}[WARNING]${NC} $1"
}

info() {
echo -e "${BLUE}[INFO]${NC} $1"
}

# Verify Part 1 installation

verify_part1() {
log "üîç Verifying Part 1 installation‚Ä¶"


# Check if we're running as user
if [[ $EUID -eq 0 ]]; then
    error "Do not run Part 2 as root. Run as user $USERNAME"
fi

# Check AppArmor
if ! sudo systemctl is-active apparmor >/dev/null 2>&1; then
    error "AppArmor not running. Check Part 1 installation."
fi

# Check Podman
if ! command -v podman >/dev/null 2>&1; then
    error "Podman not found. Check Part 1 installation."
fi

log "‚úÖ Part 1 verification complete"


}

# Install GPU drivers and CUDA

setup_gpu_cuda() {
log "üéÆ Setting up NVIDIA GPU and CUDA‚Ä¶"


# Install NVIDIA drivers
sudo pacman -S --noconfirm \
    nvidia-dkms \
    nvidia-utils \
    nvidia-settings \
    lib32-nvidia-utils \
    cuda \
    cudnn \
    opencl-nvidia

# Configure NVIDIA persistence
sudo systemctl enable nvidia-persistenced

# Add user to video group
sudo usermod -a -G video $USERNAME

# Configure NVIDIA settings
sudo tee /etc/modprobe.d/nvidia.conf > /dev/null << 'EOF'


# Enable NVIDIA KMS

options nvidia-drm modeset=1

# Security hardening

options nvidia NVreg_RestrictProfilingToAdminUsers=1
EOF


# Update initramfs
sudo mkinitcpio -P

log "‚úÖ NVIDIA GPU and CUDA setup complete"


}

# Install minimal KDE Plasma

setup_minimal_kde() {
log "üñ•Ô∏è Installing minimal KDE Plasma‚Ä¶"


# Install minimal KDE
sudo pacman -S --noconfirm \
    xorg-server \
    plasma-desktop \
    plasma-workspace \
    kscreen \
    plasma-systemmonitor \
    konsole \
    dolphin \
    kate \
    sddm \
    sddm-kcm \
    ark \
    spectacle \
    breeze \
    plasma-browser-integration

# Enable SDDM
sudo systemctl enable sddm

# Configure SDDM for security
sudo tee /etc/sddm.conf > /dev/null << 'EOF'


[General]
HaltCommand=/usr/bin/systemctl poweroff
RebootCommand=/usr/bin/systemctl reboot
Numlock=on

[Theme]
Current=breeze

[Users]
MaximumUid=60513
MinimumUid=1000
HideUsers=
HideShells=/bin/false,/usr/bin/nologin

[X11]
MinimumVT=1
ServerArguments=-nolisten tcp -dpi 96
EOF


# Disable unnecessary KDE services
sudo systemctl mask \
    plasma-baloorunner \
    baloo-file \
    baloo-file-extractor

log "‚úÖ Minimal KDE Plasma installed"


}

# Setup Firefox with AppArmor isolation

setup_firefox_isolation() {
log "ü¶ä Setting up Firefox with AppArmor isolation‚Ä¶"

# Explicitly install apparmor to ensure all abstractions are present
sudo pacman -S --noconfirm apparmor

# Install Firefox
sudo pacman -S --noconfirm firefox

# Create Firefox AppArmor profile
sudo tee /etc/apparmor.d/firefox-fortress > /dev/null << 'EOF'


# Firefox security profile for Fortress

#include <tunables/global>

profile firefox-fortress /usr/lib/firefox/firefox flags=(attach_disconnected) {
#include <abstractions/base>
#include <abstractions/audio>
#include <abstractions/dbus-session-strict>
#include <abstractions/dbus-accessibility-strict>
#include <abstractions/fonts>
#include <abstractions/freedesktop.org>
#include <abstractions/mesa>
#include <abstractions/nameservice>
#include <abstractions/openssl>
#include <abstractions/p11-kit>
#include <abstractions/ssl_certs>
#include <abstractions/user-tmp>
#include <abstractions/wayland>
#include <abstractions/X>

owner @{HOME}/.config/dconf/user r,
owner @{HOME}/.cache/fontconfig/ rw,
owner @{HOME}/.cache/fontconfig/** rw,

# Firefox binary and libraries

/usr/lib/firefox/firefox rix,
/usr/lib/firefox/** r,
/usr/lib/firefox/plugin-container ix,
/usr/lib/firefox/firefox-bin rix,

# Firefox profile directory (restricted)

owner @{HOME}/.mozilla/firefox/fortress-secure/** rw,
owner @{HOME}/.mozilla/firefox/profiles.ini r,
owner @{HOME}/.mozilla/firefox/installs.ini r,

# Downloads directory (restricted)

owner @{HOME}/Downloads/firefox/** rw,
owner @{HOME}/Downloads/firefox/ rw,

# System directories (read-only)

/usr/share/firefox/** r,
/usr/share/mime/** r,
/usr/share/applications/** r,
/etc/firefox/** r,
/etc/mime.types r,

# Networking

network inet dgram,
network inet stream,
network inet6 dgram,
network inet6 stream,
network netlink raw,

# Process control

/usr/bin/lsb_release Px,
/usr/bin/basename ix,
/usr/bin/dirname ix,

# Denied access

deny @{HOME}/.ssh/** rw,
deny @{HOME}/.gnupg/** rw,
deny @{HOME}/Documents/** rw,
deny @{HOME}/.config/** rw,
deny @{HOME}/.local/share/** rw,
deny /etc/shadow r,
deny /etc/passwd r,
deny /proc/*/environ r,
deny /sys/devices/virtual/dmi/** r,
deny capability sys_admin,
deny capability sys_ptrace,
deny capability sys_module,

# Temporary files

owner /tmp/firefox-fortress/** rw,
owner /var/tmp/firefox-fortress/** rw,
}
EOF


# Create secure Firefox profile and necessary directories
log "Manually creating secure Firefox profile..."
mkdir -p "$HOME/.mozilla/firefox/fortress-secure"

# Create profiles.ini so Firefox knows about the new profile on first launch
tee "$HOME/.mozilla/firefox/profiles.ini" > /dev/null << 'EOF'
[Install4F96D09476724483]
Default=fortress-secure
Locked=1

[Profile1]
Name=fortress-secure
IsRelative=1
Path=fortress-secure
Default=1

[General]
StartWithLastProfile=1
Version=2
EOF

# Create Firefox user.js for security
tee $HOME/.mozilla/firefox/fortress-secure/user.js > /dev/null << 'EOF'


// Firefox Security Configuration for Fortress
// Disable telemetry and data collection
user_pref("datareporting.policy.dataSubmissionEnabled", false);
user_pref("datareporting.healthreport.uploadEnabled", false);
user_pref("toolkit.telemetry.unified", false);
user_pref("toolkit.telemetry.enabled", false);
user_pref("browser.newtabpage.activity-stream.feeds.telemetry", false);
user_pref("browser.newtabpage.activity-stream.telemetry", false);
user_pref("browser.ping-centre.telemetry", false);

// Disable studies and experiments
user_pref("app.shield.optoutstudies.enabled", false);
user_pref("app.normandy.enabled", false);
user_pref("app.normandy.api_url", "");

// Enhanced security settings
user_pref("security.tls.version.min", 3);
user_pref("security.ssl.require_safe_negotiation", true);
user_pref("security.ssl.treat_unsafe_negotiation_as_broken", true);
user_pref("security.tls.insecure_fallback_hosts", "");
user_pref("security.cert_pinning.enforcement_level", 2);

// Privacy enhancements
user_pref("privacy.trackingprotection.enabled", true);
user_pref("privacy.trackingprotection.socialtracking.enabled", true);
user_pref("privacy.resistFingerprinting", true);
user_pref("privacy.firstparty.isolate", true);
user_pref("network.cookie.cookieBehavior", 1);
user_pref("network.http.referer.XOriginPolicy", 1);

// Disable dangerous features
user_pref("javascript.options.wasm", false);
user_pref("dom.webnotifications.enabled", false);
user_pref("geo.enabled", false);
user_pref("media.navigator.enabled", false);
user_pref("webgl.disabled", true);

// Network isolation
user_pref("network.proxy.type", 0);
user_pref("network.dns.disablePrefetch", true);
user_pref("network.prefetch-next", false);
user_pref("network.predictor.enabled", false);
EOF


# Load Firefox AppArmor profile
sudo apparmor_parser -r /etc/apparmor.d/firefox-fortress

# Create Firefox launcher script
mkdir -p $HOME/.local/bin
tee $HOME/.local/bin/firefox-fortress > /dev/null << 'EOF'


#!/bin/bash

# Launcher to enforce AppArmor profile on host Firefox

exec aa-exec -p firefox-fortress /usr/lib/firefox/firefox "$@"
EOF


chmod +x $HOME/.local/bin/firefox-fortress

log "‚úÖ Firefox isolation configured"


}

# Setup development environment with proper Python version management

# Setup development environment with proper Python version management

setup_development() {
log ‚Äúüíª Setting up development environment‚Ä¶‚Äù
export PATH=‚Äù$HOME/.local/bin:$PATH‚Äù


# Install development tools and optimized Python stack
sudo pacman -S --noconfirm \
    base-devel \
    python-numpy \
    python-scipy \
    python-pandas \
    python-matplotlib \
    python-scikit-learn \
    python-pytorch-cuda \
    python-tensorflow-cuda \
    jupyter-notebook \
    python-pip \
    python-virtualenv \
    nodejs \
    npm \
    go \
    podman-compose \
    github-cli \
    git \
    vim

# Install Rust
sudo pacman -S --needed --noconfirm rustup
rustup default stable

# Install paru (AUR helper) securely
if ! command -v paru >/dev/null 2>&1; then
    log "Installing paru AUR helper..."
    cd /tmp
    git clone https://aur.archlinux.org/paru.git
    cd paru
    makepkg -si --noconfirm
    cd ~
    rm -rf /tmp/paru
fi

# Install VSCodium after paru is available
paru -S --noconfirm vscodium-bin

# Create secure development directories
mkdir -p $HOME/{Projects,AI,Scripts}
chmod 750 $HOME/{Projects,AI,Scripts}

# Configure Git
git config --global init.defaultBranch main
git config --global pull.rebase true
git config --global core.editor vim

# Create lightweight development environment using system packages
log "Creating optimized Python environment..."
python -m venv --system-site-packages $HOME/.local/share/dev-env
source $HOME/.local/share/dev-env/bin/activate

# Install only additional development tools
pip install --no-deps black flake8 pylint pytest mypy semgrep bandit

# Create activation script
tee $HOME/.local/bin/dev-activate > /dev/null << 'EOF'


#!/bin/bash
source $HOME/.local/share/dev-env/bin/activate
echo ‚Äúüêç Development environment activated (System Python + extras)‚Äù
echo ‚ÄúPython: $(python ‚Äìversion)‚Äù
echo ‚ÄúPyTorch: $(python -c ‚Äòimport torch; print(torch.**version**)‚Äô 2>/dev/null || echo ‚ÄòNot available‚Äô)‚Äù
echo ‚ÄúTensorFlow: $(python -c ‚Äòimport tensorflow; print(tensorflow.**version**)‚Äô 2>/dev/null || echo ‚ÄòNot available‚Äô)‚Äù
EOF


chmod +x $HOME/.local/bin/dev-activate

deactivate

log "‚úÖ Development environment configured with optimized Python stack"
info "Use 'dev-activate' to activate development environment"


}

# Setup Obsidian with Syncthing

setup_obsidian_syncthing() {
log "üìù Setting up Obsidian with Syncthing‚Ä¶"


# Install Obsidian and Syncthing
paru -S --noconfirm obsidian syncthing

# Create Obsidian vault directory
mkdir -p $HOME/Documents/ObsidianVault

# Create Obsidian AppArmor profile
sudo tee /etc/apparmor.d/obsidian > /dev/null << 'EOF'


# Obsidian security profile

#include <tunables/global>

profile obsidian /opt/Obsidian/obsidian flags=(attach_disconnected) {
#include <abstractions/base>
#include <abstractions/fonts>
#include <abstractions/freedesktop.org>
#include <abstractions/user-tmp>
#include <abstractions/wayland>
#include <abstractions/X>

owner @{HOME}/.config/dconf/user r,
owner @{HOME}/.cache/fontconfig/ rw,
owner @{HOME}/.cache/fontconfig/** rw,

# Obsidian binary and libraries

/opt/Obsidian/obsidian rix,
/opt/Obsidian/** r,

# Vault access (restricted to vault directory)

owner @{HOME}/Documents/ObsidianVault/** rw,
owner @{HOME}/.config/obsidian/** rw,

# System directories (read-only)

/usr/share/applications/** r,
/usr/share/mime/** r,

# Networking (required for sync and plugins)

network inet dgram,
network inet stream,
network inet6 dgram,
network inet6 stream,

# Deny sensitive directories

deny @{HOME}/.ssh/** rw,
deny @{HOME}/.gnupg/** rw,
deny capability sys_admin,
deny capability sys_ptrace,
deny capability sys_module,
}
EOF


# Load Obsidian AppArmor profile
sudo apparmor_parser -r /etc/apparmor.d/obsidian

# Configure Syncthing
systemctl --user enable syncthing.service
systemctl --user start syncthing.service

# Create Syncthing AppArmor profile
sudo tee /etc/apparmor.d/syncthing > /dev/null << 'EOF'


# Syncthing security profile

#include <tunables/global>

profile syncthing /usr/bin/syncthing flags=(attach_disconnected) {
#include <abstractions/base>
#include <abstractions/nameservice>
#include <abstractions/openssl>

# Syncthing binary

/usr/bin/syncthing rix,

# Configuration and data

owner @{HOME}/.config/syncthing/** rw,
owner @{HOME}/.local/share/syncthing/** rw,
owner @{HOME}/Documents/ObsidianVault/** rw,

# Network access for sync

network inet dgram,
network inet stream,
network inet6 dgram,
network inet6 stream,

# Deny sensitive directories

deny @{HOME}/.ssh/** rw,
deny @{HOME}/.gnupg/** rw,
deny capability sys_admin,
deny capability sys_ptrace,
deny capability sys_module,
}
EOF


# Load Syncthing AppArmor profile
sudo apparmor_parser -r /etc/apparmor.d/syncthing

log "‚úÖ Obsidian and Syncthing configured"
info "Access Syncthing at: http://127.0.0.1:8384"


}

# üî± FORTRESS DNS - FIXED AND HARDENED VERSION üî±

setup_fortress_dns() {
log ‚Äúüõ°Ô∏è FORTRESS DNS: Deploying Production Hardened & Sovereign Setup‚Ä¶‚Äù


# --- SYSTEM RESOURCE DETECTION ---
local CPU_THREADS
CPU_THREADS=$(nproc)
local CACHE_SLABS=$CPU_THREADS
info "System detected with $CPU_THREADS CPU threads. Tuning Unbound accordingly."

# --- INSTALLATION WITH ERROR CHECKING ---
log "Installing Unbound and DNSCrypt-Proxy..."
if ! sudo pacman -S --needed --noconfirm unbound dnscrypt-proxy; then
    error "Failed to install DNS packages"
    return 1
fi

# --- STOP AND DISABLE CONFLICTING SERVICES FIRST ---
log "Stopping conflicting DNS services..."
sudo systemctl stop systemd-resolved dnsmasq 2>/dev/null || true
sudo systemctl disable systemd-resolved dnsmasq 2>/dev/null || true
sudo systemctl mask systemd-resolved.service

# --- CREATE DNSCRYPT-PROXY USER (CRITICAL FIX) ---
log "Ensuring dnscrypt-proxy user exists..."
if ! id dnscrypt-proxy &>/dev/null; then
    sudo useradd -r -s /usr/bin/nologin -d /var/lib/dnscrypt-proxy -c "DNSCrypt Proxy" dnscrypt-proxy
fi

# --- CONFIGURE DNSCRYPT-PROXY ---
log "Configuring dnscrypt-proxy for Oblivious DoH transport..."

# Ensure config directory exists
sudo mkdir -p /etc/dnscrypt-proxy

sudo tee /etc/dnscrypt-proxy/dnscrypt-proxy.toml > /dev/null << 'EOF'


# DNSCrypt-Proxy Configuration for Fortress

server_names = [‚Äòcloudflare‚Äô, ‚Äòquad9-dnscrypt-ip4-nofilter-pri‚Äô, ‚Äògoogle‚Äô]

# Listen only on localhost for Unbound

listen_addresses = [‚Äò127.0.0.1:5353‚Äô, ‚Äò[::1]:5353‚Äô]

# Disable caching - Unbound handles this

cache = false

# Security requirements

require_dnssec = true
require_nolog = true
require_nofilter = false

# Protocol preferences

dnscrypt_servers = true
doh_servers = true
odoh_servers = false  # Simplified for reliability
dot_servers = false

# Performance settings

timeout = 5000
keepalive = 30
lb_strategy = ‚Äòp2‚Äô
lb_estimator = true

# Privacy settings

block_unqualified = true
block_undelegated = true

# Fallback resolvers for bootstrapping

fallback_resolvers = [‚Äò9.9.9.9:53‚Äô, ‚Äò1.1.1.1:53‚Äô, ‚Äò8.8.8.8:53‚Äô]
ignore_system_dns = true

# Logging (minimal for security)

log_level = 1
log_file = ‚Äò/var/log/dnscrypt-proxy/dnscrypt-proxy.log‚Äô

# Sources

[sources]
[sources.‚Äòpublic-resolvers‚Äô]
urls = [‚Äòhttps://raw.githubusercontent.com/DNSCrypt/dnscrypt-resolvers/master/v3/public-resolvers.md‚Äô, ‚Äòhttps://download.dnscrypt.info/resolvers-list/v3/public-resolvers.md‚Äô]
cache_file = ‚Äò/var/cache/dnscrypt-proxy/public-resolvers.md‚Äô
minisign_key = ‚ÄòRWQf6LRCGA9i53mlYecO4IzT51TGPpvWucNSCh1CBM0QTaLn73Y7GFO3‚Äô
EOF


# Create log directory
sudo mkdir -p /var/log/dnscrypt-proxy
sudo chown dnscrypt-proxy:dnscrypt-proxy /var/log/dnscrypt-proxy

# Create cache directory
sudo mkdir -p /var/cache/dnscrypt-proxy
sudo chown dnscrypt-proxy:dnscrypt-proxy /var/cache/dnscrypt-proxy

# --- CONFIGURE UNBOUND ---
log "Configuring Unbound as hardened recursive resolver..."

# Backup original config
sudo cp /etc/unbound/unbound.conf /etc/unbound/unbound.conf.backup 2>/dev/null || true

sudo tee /etc/unbound/unbound.conf > /dev/null << EOF


server:
# Network configuration
interface: 127.0.0.1@53
interface: ::1@53
port: 53
do-ip4: yes
do-ip6: yes
do-udp: yes
do-tcp: yes


# Access control
access-control: 127.0.0.0/8 allow
access-control: ::1/128 allow
access-control: 0.0.0.0/0 refuse
access-control: ::/0 refuse

# Performance tuning (dynamic values)
num-threads: $CPU_THREADS
msg-cache-slabs: $CACHE_SLABS
rrset-cache-slabs: $CACHE_SLABS
infra-cache-slabs: $CACHE_SLABS
key-cache-slabs: $CACHE_SLABS
so-reuseport: yes

# Cache settings
msg-cache-size: 128m
rrset-cache-size: 256m
outgoing-range: 8192
num-queries-per-thread: 4096
so-rcvbuf: 4m
so-sndbuf: 4m

# Cache behavior
cache-min-ttl: 0
cache-max-ttl: 86400
serve-expired: yes
serve-expired-ttl: 3600
prefetch: yes
prefetch-key: yes

# DNSSEC
auto-trust-anchor-file: "/var/lib/unbound/root.key"
val-clean-additional: yes
harden-dnssec-stripped: yes

# Security hardening
hide-identity: yes
hide-version: yes
harden-glue: yes
harden-below-nxdomain: yes
harden-referral-path: yes
qname-minimisation: yes
qname-minimisation-strict: yes
aggressive-nsec: yes
use-caps-for-id: yes
unwanted-reply-threshold: 10000000

# Private address protection
private-address: 10.0.0.0/8
private-address: 172.16.0.0/12
private-address: 192.168.0.0/16
private-address: 169.254.0.0/16
private-address: fd00::/8
private-address: fe80::/10

# Forward to dnscrypt-proxy
do-not-query-localhost: no


forward-zone:
name: ‚Äú.‚Äù
forward-addr: 127.0.0.1@5353
forward-addr: ::1@5353

# Include additional configurations

include: ‚Äú/etc/unbound/conf.d/*.conf‚Äù
EOF


# Create config directory for additional files
sudo mkdir -p /etc/unbound/conf.d

# --- SETUP BLOCKLIST ---
log "Setting up DNS blocklist system..."

sudo tee /usr/local/bin/update-dns-blocklist > /dev/null << 'EOF'


#!/bin/bash
set -euo pipefail

BLOCKLIST_PATH=‚Äù/etc/unbound/conf.d/blocklist.conf‚Äù
TEMP_FILE=$(mktemp)
USER_AGENT=‚ÄúFortress-DNS-Blocklist/1.0‚Äù

# Reliable blocklist sources

SOURCES=(
‚Äúhttps://raw.githubusercontent.com/StevenBlack/hosts/master/hosts‚Äù
‚Äúhttps://someonewhocares.org/hosts/zero/hosts‚Äù
‚Äúhttps://raw.githubusercontent.com/AdguardTeam/AdguardFilters/master/BaseFilter/sections/adservers.txt‚Äù
)

# Process blocklists

{
for url in ‚Äú${SOURCES[@]}‚Äù; do
echo ‚Äú# Fetching from $url‚Äù >&2
timeout 30 curl -sS -A ‚Äú$USER_AGENT‚Äù ‚Äìconnect-timeout 10 ‚Äú$url‚Äù 2>/dev/null || {
echo ‚Äú# Failed to fetch $url‚Äù >&2
continue
}
done
} | awk ‚Äô
# Process hosts format
/^(0.0.0.0|127.0.0.1)[[:space:]]+[^[:space:]#]/ && $2 !~ /^(localhost|localhost.localdomain|local|broadcasthost)$/ {
gsub(/\r/, ‚Äú‚Äù)
domain = $2
gsub(/[^a-zA-Z0-9.-]/, ‚Äú‚Äù, domain)
if (domain && length(domain) > 1 && domain !~ /^[0-9.]+$/) {
domains[domain] = 1
}
}
# Process AdGuard format
/^||[a-zA-Z0-9.-]+^/ {
gsub(/[|^]/, ‚Äú‚Äù)
gsub(/\r/, ‚Äú‚Äù)
domain = $0
if (domain && length(domain) > 1) {
domains[domain] = 1
}
}
# Process plain domain lists
/^[a-zA-Z0-9.-]+$/ && !/^#/ && !/localhost/ {
gsub(/\r/, ‚Äú‚Äù)
domain = $0
if (domain && length(domain) > 1 && domain !~ /^[0-9.]+$/) {
domains[domain] = 1
}
}
END {
for (domain in domains) {
if (length(domain) > 3 && domain ~ /./) {
print ‚Äúlocal-zone: "‚Äù domain ‚Äú." refuse‚Äù
}
}
}
‚Äô | sort -u > ‚Äú$TEMP_FILE‚Äù

# Validate and install blocklist

if [ -s ‚Äú$TEMP_FILE‚Äù ] && [ ‚Äú$(wc -l < ‚Äú$TEMP_FILE‚Äù)‚Äù -gt 100 ]; then
sudo mv ‚Äú$TEMP_FILE‚Äù ‚Äú$BLOCKLIST_PATH‚Äù
sudo chown root:root ‚Äú$BLOCKLIST_PATH‚Äù
sudo chmod 644 ‚Äú$BLOCKLIST_PATH‚Äù


# Reload Unbound if running
if systemctl is-active --quiet unbound; then
    sudo unbound-control reload_keep_cache >/dev/null 2>&1 || true
fi

echo "Updated blocklist with $(wc -l < "$BLOCKLIST_PATH") domains"
logger "Fortress DNS: Blocklist updated with $(wc -l < "$BLOCKLIST_PATH") domains"


else
echo ‚ÄúBlocklist update failed or too few domains found‚Äù
rm -f ‚Äú$TEMP_FILE‚Äù
exit 1
fi
EOF


sudo chmod +x /usr/local/bin/update-dns-blocklist

# Create whitelist for essential domains
sudo tee /etc/unbound/conf.d/whitelist.conf > /dev/null << 'EOF'


# Essential domains whitelist

local-zone: ‚Äúarchlinux.org.‚Äù transparent
local-zone: ‚Äúgithub.com.‚Äù transparent
local-zone: ‚Äúgithubusercontent.com.‚Äù transparent
local-zone: ‚Äúcloudflare.com.‚Äù transparent
local-zone: ‚Äúquad9.net.‚Äù transparent
local-zone: ‚Äúmozilla.org.‚Äù transparent
EOF


# Run initial blocklist update
sudo /usr/local/bin/update-dns-blocklist || warning "Initial blocklist update failed, continuing..."

# --- SYSTEMD SERVICE CONFIGURATION ---
log "Configuring systemd services..."

# Override dnscrypt-proxy service to ensure proper user
sudo mkdir -p /etc/systemd/system/dnscrypt-proxy.service.d
sudo tee /etc/systemd/system/dnscrypt-proxy.service.d/override.conf > /dev/null << 'EOF'


[Unit]
After=network-online.target
Wants=network-online.target

[Service]
User=dnscrypt-proxy
Group=dnscrypt-proxy
ExecStart=
ExecStart=/usr/bin/dnscrypt-proxy -config /etc/dnscrypt-proxy/dnscrypt-proxy.toml
Restart=always
RestartSec=10
NoNewPrivileges=true
EOF


# Override unbound service for proper dependencies
sudo mkdir -p /etc/systemd/system/unbound.service.d
sudo tee /etc/systemd/system/unbound.service.d/override.conf > /dev/null << 'EOF'


[Unit]
After=network-online.target dnscrypt-proxy.service
Wants=network-online.target
Requires=dnscrypt-proxy.service

[Service]
Restart=always
RestartSec=5
EOF


# --- SYSTEMD TIMERS FOR BLOCKLIST UPDATES ---
log "Setting up automatic blocklist updates..."

sudo tee /etc/systemd/system/dns-blocklist-update.service > /dev/null << 'EOF'


[Unit]
Description=Update DNS blocklist
After=network-online.target
Wants=network-online.target

[Service]
Type=oneshot
ExecStart=/usr/local/bin/update-dns-blocklist
User=root
EOF


sudo tee /etc/systemd/system/dns-blocklist-update.timer > /dev/null << 'EOF'


[Unit]
Description=Daily DNS blocklist update
Requires=dns-blocklist-update.service

[Timer]
OnCalendar=daily
RandomizedDelaySec=1h
Persistent=true

[Install]
WantedBy=timers.target
EOF


# --- NETWORK CONFIGURATION ---
log "Configuring network settings..."

# NetworkManager DNS configuration
sudo mkdir -p /etc/NetworkManager/conf.d
sudo tee /etc/NetworkManager/conf.d/99-dns-fortress.conf > /dev/null << 'EOF'


[main]
dns=none
systemd-resolved=false

[connection]
ipv6.ip6-privacy=2
EOF


# Configure resolv.conf
sudo chattr -i /etc/resolv.conf 2>/dev/null || true
sudo tee /etc/resolv.conf > /dev/null << 'EOF'


# Fortress DNS Configuration

# Managed by Fortress DNS setup - do not edit manually

nameserver 127.0.0.1
nameserver ::1
options edns0 trust-ad timeout:2 rotate
EOF
sudo chattr +i /etc/resolv.conf


# --- SERVICE ACTIVATION ---
log "Starting and enabling services..."

sudo systemctl daemon-reload

# Enable and start services in correct order
if ! sudo systemctl enable --now dnscrypt-proxy.service; then
    error "Failed to start dnscrypt-proxy"
    return 1
fi

# Wait for dnscrypt-proxy to be ready
sleep 3

if ! sudo systemctl enable --now unbound.service; then
    error "Failed to start unbound"
    return 1
fi

# Enable blocklist updates
sudo systemctl enable --now dns-blocklist-update.timer

# Restart NetworkManager to apply DNS settings
sudo systemctl restart NetworkManager.service 2>/dev/null || true

# --- VERIFICATION ---
log "Verifying DNS setup..."
sleep 5  # Allow services to stabilize

local VERIFICATION_FAILED=false

# Test basic DNS resolution
if ! timeout 10 dig @127.0.0.1 +short archlinux.org >/dev/null 2>&1; then
    error "Basic DNS resolution test failed"
    VERIFICATION_FAILED=true
fi

# Test DNSSEC validation
if timeout 10 dig @127.0.0.1 +dnssec archlinux.org | grep -q "ad"; then
    log "‚úÖ DNSSEC validation working"
else
    warning "DNSSEC validation may not be working properly"
fi

# Check service status
if ! systemctl is-active --quiet dnscrypt-proxy; then
    error "dnscrypt-proxy service is not running"
    VERIFICATION_FAILED=true
fi

if ! systemctl is-active --quiet unbound; then
    error "unbound service is not running"
    VERIFICATION_FAILED=true
fi

# Test connectivity to upstream
if ! timeout 5 nc -zv 127.0.0.1 5353 2>/dev/null; then
    error "Cannot connect to dnscrypt-proxy on port 5353"
    VERIFICATION_FAILED=true
fi

if [ "$VERIFICATION_FAILED" = true ]; then
    error "DNS verification failed. Check services:"
    error "sudo systemctl status dnscrypt-proxy unbound"
    error "sudo journalctl -u dnscrypt-proxy -u unbound --since '5 minutes ago'"
    return 1
fi

# Success reporting
local BLOCKLIST_COUNT
BLOCKLIST_COUNT=$(grep -c "local-zone:" /etc/unbound/conf.d/blocklist.conf 2>/dev/null || echo "0")

log "‚úÖ DNS resolution working correctly"
log "‚úÖ Services running: dnscrypt-proxy, unbound"
log "‚úÖ Blocklist active with $BLOCKLIST_COUNT domains"
log "‚úÖ Automatic updates enabled"
log "üõ°Ô∏è FORTRESS DNS is online and protecting your network"

info "Configuration summary:"
info "  ‚Ä¢ Recursive resolver: Unbound (127.0.0.1:53)"
info "  ‚Ä¢ Upstream transport: DNSCrypt-Proxy (127.0.0.1:5353)"
info "  ‚Ä¢ DNSSEC validation: Enabled"
info "  ‚Ä¢ Ad blocking: $BLOCKLIST_COUNT domains blocked"
info "  ‚Ä¢ Privacy: Enhanced with encrypted upstream"

return 0


}

# Setup Snapper for snapshots

setup_snapper() {
log "üì∏ Setting up Snapper for snapshots‚Ä¶"


# Install Snapper
sudo pacman -S --noconfirm snapper snap-pac

# Create Snapper configuration for root
sudo snapper -c root create-config /

# Create Snapper configuration for home
sudo snapper -c home create-config /home

# Configure Snapper settings for both root and home
for config in root home; do
    log "üîß Configuring Snapper for '$config'..."
    sudo snapper -c "$config" set-config \
        "TIMELINE_CREATE=yes" \
        "TIMELINE_LIMIT_HOURLY=5" \
        "TIMELINE_LIMIT_DAILY=7" \
        "TIMELINE_LIMIT_WEEKLY=0" \
        "TIMELINE_LIMIT_MONTHLY=2" \
        "NUMBER_CLEANUP=yes" \
        "NUMBER_LIMIT=25" \
        "NUMBER_LIMIT_IMPORTANT=10"
done

# Enable Snapper timers
sudo systemctl enable --now snapper-timeline.timer
sudo systemctl enable --now snapper-cleanup.timer

# Create initial snapshot
sudo snapper -c root create --description "Initial fortress snapshot"

log "‚úÖ Snapper configured"


}

# Setup system monitoring

setup_monitoring() {
log "üìä Setting up system monitoring‚Ä¶"


# Install monitoring tools
sudo pacman -S --noconfirm \
    htop \
    iotop \
    nethogs \
    fail2ban \
    logwatch \
    rkhunter

# Configure fail2ban
sudo tee /etc/fail2ban/jail.local > /dev/null << 'EOF'


[DEFAULT]
bantime = 3600
findtime = 600
maxretry = 3
backend = systemd
usedns = warn
logencoding = auto
enabled = false
filter = %(**name**)s
destemail = root@localhost
sender = root@localhost
action = %(action_)s

[sshd]
enabled = true
port = ssh
logpath = %(sshd_log)s
backend = %(sshd_backend)s
banaction = firewallcmd-multiport
EOF


# Enable fail2ban
sudo systemctl enable --now fail2ban

# Configure rkhunter
sudo rkhunter --update
sudo rkhunter --propupd

# Create monitoring script
tee $HOME/.local/bin/fortress-status > /dev/null << 'EOF'


#!/bin/bash

# Fortress System Status

echo "üî± FORTRESS STATUS REPORT üî±"
echo "=================================="
echo

echo "üìä System Resources:"
echo "CPU: $(grep 'cpu ' /proc/stat | awk '{usage=($2+$4)*100/($2+$4+$5)} END {print usage "%"}')"
echo "Memory: $(free | grep Mem | awk '{printf("%.1f%%\n", $3/$2 * 100.0)}')"
echo "Disk: $(df -h / | awk 'NR==2{print $5}')"
echo

echo "üîí Security Status:"
echo "AppArmor: $(sudo apparmor_status | grep -c 'profiles are loaded')"
echo "Firewall: $(sudo firewall-cmd --state 2>/dev/null || echo 'inactive')"
echo "Fail2ban: $(sudo fail2ban-client status | grep -c 'jail(s)')"
echo

echo "üê≥ Container Status:"
podman ps --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
echo

echo "üì∏ Recent Snapshots:"
sudo snapper -c root list -t single | tail -5
echo

echo "üêç Python Environments:"
echo "System Python: $(python --version 2>/dev/null || echo 'Not available')"
if [[ -f "$HOME/.local/share/dev-env/bin/python" ]]; then
echo "Dev Environment: $($HOME/.local/share/dev-env/bin/python --version)"
fi
EOF


chmod +x $HOME/.local/bin/fortress-status

log "‚úÖ System monitoring configured"


}

# Setup MAC address randomization

setup_mac_randomization() {
log "üîí Configuring MAC address randomization‚Ä¶"


# Create a NetworkManager configuration file for MAC randomization
sudo tee /etc/NetworkManager/conf.d/00-macrandomize.conf > /dev/null << 'EOF'


# Enable MAC address randomization for privacy

[device]

# Randomize MAC address during Wi-Fi scans

wifi.scan-rand-mac-address=yes

[connection]

# Use a stable, per-network random MAC address for Wi-Fi

wifi.cloned-mac-address=stable

# Use a stable, random MAC address for Ethernet

ethernet.cloned-mac-address=stable

# Generate a stable ID for connections

connection.stable-id=${CONNECTION}/${BOOT}
EOF


log "‚úÖ MAC address randomization enabled for new connections."
info "Existing connections may need to be modified with 'nmcli'."


}

# Apply final security hardening

apply_final_hardening() {
log "üîê Applying final security hardening‚Ä¶"


# Create security aliases
tee -a $HOME/.bashrc > /dev/null << 'EOF'


# Fortress Security Aliases

alias ls='ls --color=auto'
alias ll='ls -alF'
alias la='ls -A'
alias l='ls -CF'
alias grep='grep --color=auto'
alias firefox='firefox-fortress'
alias status='fortress-status'
alias ss='sudo snapper -c root create --description'
alias sr='sudo snapper -c root'

# Security-focused PATH

export PATH="$HOME/.local/bin:$PATH"

# Development environment

alias dev='dev-activate'
alias dev-env='source $HOME/.local/share/dev-env/bin/activate'

EOF


# Set proper permissions
chmod 700 $HOME/.ssh 2>/dev/null || true
chmod 600 $HOME/.ssh/* 2>/dev/null || true
chmod 700 $HOME/.gnupg 2>/dev/null || true
chmod 600 $HOME/.gnupg/* 2>/dev/null || true


}

# Main installation function

main() {
log "üî± Starting Arch Fortress Installation - Part 2 üî±"


# Verify Part 1 installation
verify_part1

# GPU and KDE setup
#setup_gpu_cuda
#setup_minimal_kde

# Application isolation
#setup_firefox_isolation
#setup_obsidian_syncthing

# Development environment (with fixed Python compatibility)
#setup_development

# A function to log messages
log() {
    echo -e "[\e[32m+\e[0m] $1"
}

# A function to log errors
error() {
    echo -e "[\e[31m!\e[0m] $1" >&2
}
# Execute dns function
setup_fortress_dns

# System maintenance
setup_snapper
setup_monitoring

# Final hardening
setup_mac_randomization
apply_final_hardening

log "‚úÖ Enabling Podman auto-update for containers..."
systemctl --user enable --now podman-auto-update.timer
podman auto-update

log "üéâ Arch Fortress Part 2 Installation Complete! üéâ"
log "üìã Next steps:"
log "   1. Reboot to load GPU drivers and KDE"
log "   2. Set up Syncthing at http://127.0.0.1:8384"
log "   3. Run 'fortress-status' to check system"
log "   4. Use 'firefox-fortress' for secure browsing"
log "   5. Use 'dev-activate' to enter ML/AI development environment"

info "üêç Python Environment Details:"
info "   - System Python: $(python --version 2>/dev/null || echo 'Not available')"
info "   - Development Environment: Python 3.11 with ML/AI packages"
info "   - Activation: 'dev-activate' or 'source ~/.local/share/dev-env/bin/activate'"

info "üõ°Ô∏è Security Features:"
info "   - AppArmor profiles for Firefox, Obsidian and Syncthing"
info "   - MAC address randomization"
info "   - Container isolation with custom networks"
info "   - Snapshot system with automatic cleanup"
info "   - Real-time security monitoring with fail2ban"

info "üöÄ Performance Optimizations:"
info "   - NVIDIA GPU acceleration enabled"
info "   - Minimal KDE desktop environment"
info "   - Optimized container resource limits"

warning "‚ö†Ô∏è  IMPORTANT SECURITY NOTES:"
warning "   - Review and customize AppArmor profiles as needed"
warning "   - Set up firewall rules for your specific use case"
warning "   - Consider enabling full disk encryption if not already done"

log "üîß Post-installation hardening recommendations:"
log "   - Run 'sudo rkhunter --check' for rootkit detection"
log "   - Configure automatic security updates"
log "   - Set up encrypted backup strategy"
log "   - Review systemd services and disable unnecessary ones"

# Create post-installation hardening script

tee $HOME/.local/bin/fortress-harden > /dev/null << 'EOF'
#!/bin/bash

# üî± FORTRESS POST-INSTALLATION HARDENING üî±

set -euo pipefail

GREEN="\033[0;32m"
RED="\033[0;31m"
YELLOW="\033[1;33m"
NC="\033[0m"

log() { echo -e "${GREEN}[HARDEN]${NC} $1"; }
error() { echo -e "${RED}[ERROR]${NC} $1" >&2; }
warning() { echo -e "${YELLOW}[WARNING]${NC} $1"; }

log "üîí Running additional security hardening‚Ä¶"

# Disable unnecessary systemd services

log "Disabling unnecessary services‚Ä¶"
sudo systemctl disable --now bluetooth.service 2>/dev/null || true
sudo systemctl disable --now cups.service 2>/dev/null || true
sudo systemctl mask systemd-rfkill.service systemd-rfkill.socket 2>/dev/null || true

# Enable process accounting

log "Enabling process accounting‚Ä¶"
sudo systemctl enable --now psacct 2>/dev/null || true

# Create emergency recovery script

log "Creating emergency recovery tools‚Ä¶"
sudo tee /usr/local/bin/fortress-emergency > /dev/null << 'EOEMERG'
#!/bin/bash

# üö® FORTRESS EMERGENCY RECOVERY üö®

RED="\033[0;31m"
GREEN="\033[0;32m"
NC="\033[0m"

echo -e "${RED}üö® FORTRESS EMERGENCY MODE üö®${NC}"
echo "Available recovery options:"
echo "1. Disable all AppArmor profiles"
echo "2. Stop all containers"
echo "3. Reset DNS to system default"
echo "4. List recent snapshots"
echo "5. Boot to snapshot"

read -p "Select option (1-5): " choice

case $choice in
1)
    echo -e "${GREEN}Disabling AppArmor profiles (setting to complain mode)...${NC}"
    sudo aa-complain /etc/apparmor.d/*
    log "AppArmor profiles set to complain mode. Reboot to take full effect."
    ;;
2)
    echo -e "${GREEN}Stopping all containers...${NC}"
    podman stop --all
    podman system prune -f --volumes
    ;;
3)
    echo -e "${GREEN}Resetting DNS to a public resolver (1.1.1.1)...${NC}"
    sudo systemctl stop systemd-resolved
    echo "nameserver 1.1.1.1" | sudo tee /etc/resolv.conf
    sudo systemctl start systemd-resolved
    log "DNS has been reset."
    ;;
4)
    echo -e "${GREEN}Recent snapshots:${NC}"
    sudo snapper -c root list | tail -10
    ;;
5)
    echo -e "${RED}This is a destructive operation.${NC}"
    warning "This will roll back your ENTIRE root filesystem."
    read -p "Enter snapshot number to restore: " snap_num
    if [[ ! "$snap_num" =~ ^[0-9]+$ ]]; then error "Invalid number."; fi

    warning "Restoring snapshot $snap_num. The system will reboot."
    sudo snapper -c root rollback "$snap_num" && sudo reboot
    ;;
*)
    error "Invalid option"
    ;;
esac
EOEMERG

sudo chmod +x /usr/local/bin/fortress-emergency

# Set up intrusion detection alerts

log "Configuring intrusion detection‚Ä¶"
sudo tee /etc/fail2ban/action.d/fortress-alert.conf > /dev/null << 'EOALERT'
[Definition]
actionstart = echo "Fortress: fail2ban started on `hostname` at `date`" | logger -t fail2ban
actionstop = echo "Fortress: fail2ban stopped on `hostname` at `date`" | logger -t fail2ban
actioncheck =
actionban = echo "Fortress: banned <ip> from `hostname` at `date`" | logger -t fail2ban
actionunban = echo "Fortress: unbanned <ip> from `hostname` at `date`" | logger -t fail2ban

[Init]
init = 123
EOALERT

# Update fail2ban config to use alerts

sudo sed -i 's/action = %(action_)s/action = %(action_)s\n         fortress-alert/' /etc/fail2ban/jail.local
sudo systemctl restart fail2ban

log "‚úÖ Additional hardening complete!"
warning "Run 'fortress-emergency' if you encounter critical issues"
EOF

chmod +x $HOME/.local/bin/fortress-harden

# Create system integrity checker

tee $HOME/.local/bin/fortress-check > /dev/null << 'EOF'
#!/bin/bash

# üî± FORTRESS INTEGRITY CHECKER üî±

set -euo pipefail

GREEN="\033[0;32m"
RED="\033[0;31m"
YELLOW="\033[1;33m"
BLUE="\033[0;34m"
NC="\033[0m"

log() { echo -e "${GREEN}[CHECK]${NC} $1"; }
error() { echo -e "${RED}[FAIL]${NC} $1"; }
warning() { echo -e "${YELLOW}[WARN]${NC} $1"; }
info() { echo -e "${BLUE}[INFO]${NC} $1"; }

ERRORS=0

check_service() {
if systemctl --user is-active --quiet "$1" 2>/dev/null; then
log "$1 is running"
else
error "$1 is not running"
((ERRORS++))
fi
}

check_system_service() {
if sudo systemctl is-active --quiet "$1" 2>/dev/null; then
log "$1 is running"
else
error "$1 is not running"
((ERRORS++))
fi
}

echo "üî± FORTRESS INTEGRITY CHECK üî±"
echo "================================"

log "Checking core services‚Ä¶"
check_system_service apparmor
check_system_service fail2ban
check_system_service systemd-resolved

log "Checking user services‚Ä¶"
check_service syncthing.service

log "Checking AppArmor profiles‚Ä¶"
PROFILES=$(sudo apparmor_status | grep -c "profiles are loaded" || echo "0")
if [[ $PROFILES -gt 0 ]]; then
log "$PROFILES AppArmor profiles loaded"
else
error "No AppArmor profiles loaded"
((ERRORS++))
fi

log "Checking DNS resolution‚Ä¶"
if nslookup google.com 127.0.0.1 >/dev/null 2>&1; then
log "DNS resolution working"
else
error "DNS resolution failed"
((ERRORS++))
fi

log "Checking development environment‚Ä¶"
if [[ -f "$HOME/.local/share/dev-env/bin/python" ]]; then
log "Development environment exists"
PYTHON_VERSION=$($HOME/.local/share/dev-env/bin/python --version)
info "Python: $PYTHON_VERSION"
else
warning "Development environment not found"
fi

log "Checking security tools‚Ä¶"
if command -v rkhunter >/dev/null; then
log "Rootkit hunter available"
else
warning "Rootkit hunter not installed"
fi

echo "================================"
if [[ $ERRORS -eq 0 ]]; then
log "üéâ All checks passed! Fortress is secure."
else
error "‚ùå $ERRORS issues found. Run 'fortress-harden' to fix."
fi

echo
info "üí° Pro Tips:"
info "   ‚Ä¢ Run this check weekly: 'fortress-check'"
info "   ‚Ä¢ Monitor logs: 'journalctl -f'"
info "   ‚Ä¢ Check snapshots: 'sudo snapper -c root list'"
info "   ‚Ä¢ Update containers: 'podman auto-update'"
EOF

chmod +x $HOME/.local/bin/fortress-check

# Final system verification

log "Running system verification‚Ä¶"

# Check all created files exist

CRITICAL_FILES=(
"$HOME/.local/bin/fortress-status"
"$HOME/.local/bin/fortress-check"
"$HOME/.local/bin/fortress-harden"
"$HOME/.local/bin/firefox-fortress"
"$HOME/.local/bin/dev-activate"
)

for file in "${CRITICAL_FILES[@]}"; do
if [[ -f "$file" && -x "$file" ]]; then
log "‚úì $file exists and is executable"
else
error "‚úó $file missing or not executable"
fi
done

# Verify AppArmor profiles

APPARMOR_PROFILES=(
"/etc/apparmor.d/firefox-fortress"
"/etc/apparmor.d/obsidian"
"/etc/apparmor.d/syncthing"
)

for profile in "${APPARMOR_PROFILES[@]}"; do
if [[ -f "$profile" ]]; then
log "‚úì AppArmor profile $profile installed"
else
error "‚úó AppArmor profile $profile missing"
fi
done

# Update shell configuration for immediate use

source $HOME/.bashrc 2>/dev/null || true

log "üéØ FORTRESS DEPLOYMENT COMPLETE! üéØ"
echo
log "üöÄ IMMEDIATE NEXT STEPS:"
log "   1. REBOOT NOW: 'sudo reboot'"
log "   2. After reboot, run: 'fortress-check'"
log "   3. Configure DNS: http://127.0.0.1:5380 (user: admin, pass: admin)"
log "   4. Configure sync: http://127.0.0.1:8384"
log "   5. Run hardening: 'fortress-harden'"

echo
warning "üîê SECURITY CHECKLIST:"
warning "   ‚ñ° Configure firewall rules for your network"
warning "   ‚ñ° Set up encrypted backups"
warning "   ‚ñ° Test emergency recovery: 'fortress-emergency'"
warning "   ‚ñ° Schedule regular security audits"

echo
info "üõ†Ô∏è DAILY COMMANDS:"
info "   fortress-status  - System overview"
info "   fortress-check   - Integrity verification"  
info "   firefox-fortress - Secure browser"
info "   dev-activate     - ML/AI environment"

echo
log "üéâ Welcome to your impenetrable Arch Fortress! üéâ"
log "    You now have enterprise-grade security on a desktop system."
log "    Stay vigilant. Stay secure. üî±"

# Create a completion marker

touch $HOME/.fortress-part2-complete
echo "$(date)" > $HOME/.fortress-part2-complete

}

# Execute main function

main "$@"
